version: 2.1

parameters:
  helm_version:
    type: string
    default: "v3.11.2"
  terraform_version:
    type: string
    default: "1.4.4"
  hcledit_version:
    type: string
    default: "0.2.9"
  GHA_Actor:
    type: string
    default: ""
  GHA_Action:
    type: string
    default: ""
  GHA_Event:
    type: string
    default: ""

orbs:
  terraform: circleci/terraform@3.2.0
  aws-cli: circleci/aws-cli@3.1
  envsubst: sawadashota/envsubst@1.1.0

commands:
  set_tf_vars:
    description: "Sets Terraform variables"
    steps:
      - envsubst/install
      - run:
          name: Configure terraform vars
          working_directory: tests
          command: bash ci-deploy.sh set_tf_vars
  install_tf:
    description: "Install Terraform"
    parameters:
      terraform_version:
        type: string
    steps:
      - terraform/install:
          terraform_version: << parameters.terraform_version >>
  install_hcledit:
    description: "Install HCL edit"
    parameters:
      hcledit_version:
        type: string
    steps:
      - run:
          name: Install HCL edit
          working_directory: tests
          environment:
            HCLEDIT_VERSION: << parameters.hcledit_version >>
          command: bash ci-deploy.sh install_hcledit
  install_helm:
    description: "Install Helm"
    parameters:
      helm_version:
        type: string
    steps:
      - run:
          name: Install Helm
          working_directory: tests
          environment:
            HELM_VERSION: << parameters.helm_version >>
          command: bash ci-deploy.sh install_helm
  gen_pvt_key:
    description: "Generates ssh key"
    steps:
      - run:
          name: Generate pvt key
          working_directory: tests
          command: ssh-keygen -q -P '' -t rsa -b 4096 -m PEM -f domino.pem
  tf_init_apply:
    description: "Terraform init"
    steps:
      - run:
          name: Terraform init/validate/apply
          working_directory: tests
          command: |
            ## Most of this verbiage will go away after release.
            set -e
            echo "Current dir: $(pwd)"
            if [ -f "migrated.txt" ]; then
              echo "This legacy deployment has been migrated"
              bash ci-deploy.sh deploy
            elif [ -n "$MAJOR_MOD_VERSION" ] && (( $MAJOR_MOD_VERSION < 3 )) ; then
              echo "Running legacy monolithic deploy"
              envsubst < ci.tfvars.tftpl | tee terraform.tfvars
              terraform init
              terraform validate
              terraform apply --auto-approve --input=false
              bash -xp migrate-states.sh
            else
              echo "Running ci-deploy.sh deploy"
              bash ci-deploy.sh deploy
            fi
  tf_deploy:
    description: "Terraform deploy"
    steps:
      - aws-cli/setup:
          role-arn: "${AWS_IAM_ROLE}"
          session-duration: "43200"
      - tf_init_apply
  tf_destroy:
    description: "Terraform destroy"
    steps:
      - run:
          name: Terraform destroy
          working_directory: tests
          command: bash ci-deploy.sh destroy
          when: always
  tf_plan_test:
    steps:
      - aws-cli/setup:
          role-arn: "${AWS_IAM_ROLE}"
          session-duration: "900"
      - run:
          name: Terraform plan test
          working_directory: examples
          command: bash tf-plan-test.sh
jobs:
  tf-plan-test:
    docker:
      - image: cimg/aws:2023.04.1
    parameters:
      terraform_version:
        type: string
    steps:
      - checkout
      - install_tf:
          terraform_version: << parameters.terraform_version >>
      - tf_plan_test
  test-deploy:
    docker:
      - image: cimg/aws:2023.04.1
    parameters:
      terraform_version:
        type: string
      helm_version:
        type: string
    steps:
      - checkout
      - install_tf:
          terraform_version: << parameters.terraform_version >>
      - install_helm:
          helm_version: << parameters.helm_version >>
      - gen_pvt_key
      - set_tf_vars
      - tf_deploy
      - tf_destroy
  test-upgrade:
    docker:
      - image: cimg/aws:2023.04.1
    parameters:
      terraform_version:
        type: string
      helm_version:
        type: string
      hcledit_version:
        type: string
    steps:
      - checkout
      - install_tf:
          terraform_version: << parameters.terraform_version >>
      - install_helm:
          helm_version: << parameters.helm_version >>
      - install_hcledit:
          hcledit_version: << parameters.hcledit_version >>
      - gen_pvt_key
      - set_tf_vars
      - run:
          name: "Set module source to latest published release"
          working_directory: tests
          command: bash ci-deploy.sh set_mod_src_local
      - tf_deploy
      - run:
          name: "Upgrade module by applying this commit"
          working_directory: tests
          command: bash ci-deploy.sh set_mod_src_latest_rel
      - tf_init_apply
      - tf_destroy

workflows:
  test-deploy-workflow:
    when:
      equal: ["test-deploy-workflow", << pipeline.parameters.GHA_Action >>]
    jobs:
      - test-deploy:
          context: aws-oidc
          terraform_version: << pipeline.parameters.terraform_version >>
          helm_version: << pipeline.parameters.helm_version >>
  test-upgrade-workflow:
    when:
      equal: ["test-upgrade-workflow", << pipeline.parameters.GHA_Action >>]
    jobs:
      - test-upgrade:
          context: aws-oidc
          terraform_version: << pipeline.parameters.terraform_version >>
          helm_version: << pipeline.parameters.helm_version >>
          hcledit_version: << pipeline.parameters.hcledit_version >>
  examples-plan-test-workflow:
    when:
      equal:
        ["examples-plan-test-workflow", << pipeline.parameters.GHA_Action >>]
    jobs:
      - tf-plan-test:
          context: aws-oidc
          terraform_version: << pipeline.parameters.terraform_version >>
